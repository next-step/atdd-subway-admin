## Step3 - 구간 추가 기능
---

## 미션 설명

- 지하철 구간 추가 기능 구현

### 기능 요구사항

- `요구사항 설명` 에서 제공되는 인수 조건을 기반으로 지하철 구간 추가 기능 구현
- 인수 조건을 검증하는 인수테스트 작성
- 예외 케이스에 대한 검증 포함

### 프로그래밍 요구사항

- 인수 조건 정의
- 인수 조건을 검증하는 인수 테스트 작성
    - 인수 조건은 인수 테스트 메서드 상단에 주석으로 작성
- 인수 테스트를 충족하는 기능 구현
- 인수 테스트 격리
- 인수 테스트 리팩토링

### API 명세

```http request
POST /lines/1/sections HTTP/1.1
accept: */*
content-type: application/json; charset=UTF-8
host: localhost:52165

{
    "downStationId": "4",
    "upStationId": "2",
    "distance": 10
}
```

### 미션 요구사항
- 지하철 구간 등록
  - [x] 역 사이에 새로운 역을 등록
  - [x] 새로운 역을 상행 종점으로 등록
  - [x] 새로운 역을 하행 종점으로 등록
- 구간 등록 시 예외 케이스 고려
  - [x] 역 사이에 새로운 역을 등록 할 경우 기존 역 사이 길이보다 긴 거리를 등록할 수 없음
  - [x] 상행역과 하행역이 이미 노선에 모두 등록되어 있는 경우 추가할 수 없음
  - [x] 상행역과 하행역 둘 중 하나도 포함되어 있지 않은 경우 추가할 수 없음

### 구현 기능 목록
- [x] 구간 Entity 설계
  - [x] Line - 구간 - Station 연관관계 설정
- [x] 구간 일급 컬렉션 생성
  - [x] `@Embeddable` 사용
- [x] 구간 추가 기능 구현
  - [x] 상행 종점 추가
  - [x] 하행 종점 추가
  - [x] 중간 역 추가
  - [x] 역 정렬 기능 구현
  - [x] 예외 케이스
    - [x] 중간 역 추가 시 기존 역 사이 길이보다 긴 경우
    - [x] 상행역과 하행역이 이미 노선에 모두 등록되어 있는 경우
    - [x] 상행역과 하행역 둘 중 하나도 포함되어 있지 않은 경우
- [x] 구간 추가 기능 인수 테스트 작성
- [x] 구간 추가 기능 테스트 리팩토링

### 피드백 반영
- [x] 알맞은 메서드 네이밍
- [x] `removeAll()` 메서드 제거
- [x] 쿼리를 통해 비즈니스 로직 부담 줄이기
- [x] 구간 추가 기능 추상화

### 인수 조건
#### - Feature: 구간 추가 - 중간 역 추가(동일 상행역)
```text
  - Scenario: 지하철 노선에 구간을 등록한다.
    - Given 지하철 노선 "2호선"에 "강남역", "선릉역" 이 등록되어 있다.
    - And 지하철역 "역삼역"이 등록되어 있다.
    - When 지하철 노선 "2호선"에 "강남역"과 "역삼역" 구간을 추가한다.
    - Then 노선 조회 시, 추가한 구간("강남역" - "역삼역" - "선릉역")을 확인 할 수 있다.
```

#### - Feature: 구간 추가 - 중간역 추가(동일 하행역)
```text
  - Scenario: 지하철 노선에 구간을 등록한다.
    - Given 지하철 노선 "2호선"에 "강남역", "선릉역" 이 등록되어 있다.
    - And 지하철역 "역삼역"이 등록되어 있다.
    - When 지하철 노선 "2호선"에 "역삼역"과 "선릉역" 구간을 추가한다.
    - Then 노선 조회 시, 추가한 구간("강남역" - "역삼역" - "선릉역")을 확인 할 수 있다.
```

#### - Feature: 구간 추가 - 상행 종점역 추가
```text
  - Scenario: 지하철 노선에 구간을 등록한다.
    - Given 지하철 노선 "2호선"에 "강남역", "선릉역" 이 등록되어 있다.
    - And 지하철역 "삼성역"이 등록되어 있다.
    - When 지하철 노선 "2호선"에 "삼성역"과 "강남역" 구간을 추가한다.
    - Then 노선 조회 시, 추가한 구간("삼성역" - "강남역" - "선릉역")을 확인 할 수 있다.
```
#### - Feature: 구간 추가 - 하행 종점역 추가
```text
  - Scenario: 지하철 노선에 구간을 등록한다.
    - Given 지하철 노선 "2호선"에 "강남역", "선릉역" 이 등록되어 있다.
    - And 지하철역 "잠실역"이 등록되어 있다.
    - When 지하철 노선 "2호선"에 "선릉역"과 "잠실역" 구간을 추가한다.
    - Then 노선 조회 시, 추가한 구간("강남역" - "선릉역" - "잠실역")을 확인 할 수 있다.
```

#### - Feature: 구간 추가 실패 - 추가 구간의 상행/하행역이 모두 노선에 존재하는 경우 추가할 수 없다.
```text
  - Scenario: 지하철 노선에 구간을 등록 시 실패한다.
    - Given 지하철 노선 "2호선"에 "강남역", "선릉역" 이 등록되어 있다.
    - And 지하철 노선 "2호선"에 "강남역"과 "선릉역" 구간이 등록되어 있다.
    - When 지하철 노선 "2호선"에 "강남역"과 "선릉역" 구간을 추가한다.
    - Then 등록할 수 없다.
```

#### - Feature: 구간 추가 실패 - 추가 구간의 상행/하행역이 모두 노선에 존재하지 않는 경우 추가할 수 없다.
```text
  - Scenario: 지하철 노선에 구간을 등록 시 실패한다.
    - Given 지하철 노선 "2호선"에 "강남역", "선릉역" 이 등록되어 있다.
    - When 지하철 노선 "2호선"에 "삼성역"과 "잠실역" 구간을 추가한다.
    - Then 등록할 수 없다.
```

#### - Feature: 구간 추가 실패 - 추가 구간의 거리가 유효하지 않을 경우 추가할 수 없다.
```text
  - Scenario: 지하철 노선에 구간을 등록한다.
    - Given 100 의 길이를 가진 지하철 노선 "2호선"에 "강남역", "선릉역" 이 등록되어 있다.
    - And 50 의 길이를 가진 "강남역" - "역삼역" 구간이 등록되어 있다.
    - When 지하철 노선 "2호선"에 "강남역"과 "잠실역" 구간을 추가한다.
      - When 0 의 길이를 가진 구간을 추가한다.
      - When 50 의 길이를 가진 구간을 추가한다.
      - When 100 의 길이를 가진 구간을 추가한다.
    - Then 등록할 수 없다.
```
